<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LC-MS feature grouping • CompMetaboTools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="LC-MS feature grouping">
<meta property="og:description" content="CompMetaboTools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CompMetaboTools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/LC-MS-feature-grouping.html">LC-MS feature grouping</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/EuracBiomedicalResearch/CompMetaboTools/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="LC-MS-feature-grouping_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>LC-MS feature grouping</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EuracBiomedicalResearch/CompMetaboTools/blob/master/vignettes/LC-MS-feature-grouping.Rmd"><code>vignettes/LC-MS-feature-grouping.Rmd</code></a></small>
      <div class="hidden name"><code>LC-MS-feature-grouping.Rmd</code></div>

    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Package</strong>: <em><a href="https://bioconductor.org/packages/3.12/xcms">xcms</a></em><br><strong>Authors</strong>: Johannes Rainer, Mar Garcia-Aloy<br><strong>Modified</strong>: 2020-09-15 13:45:41<br><strong>Compiled</strong>: Tue Sep 15 14:22:21 2020</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co">## Silently loading all packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/Bioconductor/BiocStyle">BiocStyle</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/sneumann/xcms">xcms</a></span>)
<span class="fu">register</span>(<span class="fu">SerialParam</span>())
</pre></div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>In a typical LC-MS-based metabolomics experiment compounds eluting from the chromatography are first ionized before being measured by mass spectrometry (MS). During the ionization different (multiple) ions can be generated from the same compound which all will be measured by MS. In general, the resulting data is then pre-processed to identify chromatographic peaks in the data and to group these across samples in the correspondence analysis. The result are distinct LC-MS features, characterized by their specific m/z and retention time range. Different ions generated during ionization will be detected as different features. To reduce data set complexity (and to aid in subsequent annotation steps) it is advisable to group features which are supposedly representing signal from the same original ion. This document describes functionality to aid in this feature grouping step which are provided by this package.</p>
</div>
<div id="lc-ms-feature-grouping" class="section level1">
<h1 class="hasAnchor">
<a href="#lc-ms-feature-grouping" class="anchor"></a>LC-MS feature grouping</h1>
<p>We demonstrate the feature grouping functionality on the simple toy data set used also in the <em><a href="https://bioconductor.org/packages/3.12/xcms">xcms</a></em> package and provided through the <code>faahKO</code> package. This data set consists of samples from 4 mice with knock-out of the fatty acid amide hydrolase (FAAH) and 4 wild type mice. Pre-processing of this data set is described in detail in the <em>xcms</em> vignette of the <code>xcms</code> package. Below we load all required packages and the result from this pre-processing updating also the location of the respective raw data files on the current machine.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/sneumann/xcms">xcms</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://dx.doi.org/10.1021/bi0480335">faahKO</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/EuracBiomedicalResearch/CompMetaboTools">CompMetaboTools</a></span>)

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"xdata"</span>)
<span class="co">## Update the path to the files for the local system</span>
<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/dirname.html">dirname</a></span>(<span class="kw">xdata</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"cdf/"</span>, package = <span class="st">"faahKO"</span>),
                         <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"KO/"</span>, <span class="st">"WT/"</span>), each = <span class="fl">4</span>))
</pre></div>
<p>Before performing the feature grouping we inspect the result object. With <code>featureDefinitions</code> we can extract the results from the correspondence analysis.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)
</pre></div>
<pre><code>## DataFrame with 225 rows and 11 columns
##           mzmed     mzmin     mzmax     rtmed     rtmin     rtmax    npeaks
##       &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;
## FT001     200.1     200.1     200.1   2901.63   2880.73   2922.53         2
## FT002     205.0     205.0     205.0   2789.39   2782.30   2795.36         8
## FT003     206.0     206.0     206.0   2788.73   2780.73   2792.86         7
## FT004     207.1     207.1     207.1   2718.12   2713.21   2726.70         7
## FT005     219.1     219.1     219.1   2518.82   2517.40   2520.81         3
## ...         ...       ...       ...       ...       ...       ...       ...
## FT221    591.30     591.3     591.3   3005.03   2992.87   3006.05         5
## FT222    592.15     592.1     592.3   3022.11   2981.91   3107.59         6
## FT223    594.20     594.2     594.2   3418.16   3359.10   3427.90         3
## FT224    595.25     595.2     595.3   3010.15   2992.87   3013.77         6
## FT225    596.20     596.2     596.2   2997.91   2992.87   3002.95         2
##              KO        WT            peakidx  ms_level
##       &lt;numeric&gt; &lt;numeric&gt;             &lt;list&gt; &lt;integer&gt;
## FT001         2         0  287, 679,1577,...         1
## FT002         4         4     47,272,542,...         1
## FT003         3         4     32,259,663,...         1
## FT004         4         3     19,249,525,...         1
## FT005         1         2  639, 788,1376,...         1
## ...         ...       ...                ...       ...
## FT221         2         3    349,684,880,...         1
## FT222         1         3     86,861,862,...         1
## FT223         1         2  604, 985,1543,...         1
## FT224         2         3     67,353,876,...         1
## FT225         0         2  866,1447,1643,...         1</code></pre>
<p>Each row in this data frame represents the definition of one feature, with its average and range of m/z and retention time. Column <code>"peakidx"</code> provides the index of each chromatographic peak which is assigned to the feature in the <code>chromPeaks</code> matrix of the result object. The <code>featureValues</code> function allows to extract <em>feature values</em>, i.e. a matrix with feature abundances, one row per feature and columns representing the samples of the present data set.</p>
<p>Below we extract the feature values with and without <em>filled-in</em> peak data. Without the gap-filled data only abundances from <strong>detected</strong> chromatographic peaks are reported, with gap-filled data, for samples in which no chromatographic peak was identified (e.g. because peak detection failed for that ion in that particular sample) data was filled-in in samples in which no peak was detected integrating all signal from the MS region defined by the m/z - retention time range of the detected chromatographic peak in the other samples.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html">featureValues</a></span>(<span class="kw">xdata</span>, filled = <span class="fl">FALSE</span>))
</pre></div>
<pre><code>##        ko15.CDF  ko16.CDF  ko21.CDF  ko22.CDF  wt15.CDF  wt16.CDF  wt21.CDF
## FT001        NA  506848.9        NA  169955.6        NA        NA        NA
## FT002 1924712.0 1757151.0 1383416.7 1180288.2 2129885.1 1634342.0 1623589.2
## FT003  213659.3  289500.7        NA  178285.7  253825.6  241844.4  240606.0
## FT004  349011.5  451863.7  343897.8  208002.8  364609.8  360908.9        NA
## FT005        NA        NA        NA  107348.5  223951.8        NA        NA
## FT006  286221.4        NA  164009.0  149097.6  255697.7  311296.8  366441.5
##         wt22.CDF
## FT001         NA
## FT002 1354004.93
## FT003  185399.47
## FT004  221937.53
## FT005   84772.92
## FT006  271128.02</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html">featureValues</a></span>(<span class="kw">xdata</span>, filled = <span class="fl">TRUE</span>))
</pre></div>
<pre><code>##        ko15.CDF   ko16.CDF   ko21.CDF  ko22.CDF  wt15.CDF  wt16.CDF  wt21.CDF
## FT001  159738.1  506848.88  113441.08  169955.6  216096.6  145509.7  230477.9
## FT002 1924712.0 1757150.96 1383416.72 1180288.2 2129885.1 1634342.0 1623589.2
## FT003  213659.3  289500.67  162897.19  178285.7  253825.6  241844.4  240606.0
## FT004  349011.5  451863.66  343897.76  208002.8  364609.8  360908.9  223322.5
## FT005  135978.5   25524.79   71530.84  107348.5  223951.8  134398.9  190203.8
## FT006  286221.4  289908.23  164008.97  149097.6  255697.7  311296.8  366441.5
##         wt22.CDF
## FT001  140551.30
## FT002 1354004.93
## FT003  185399.47
## FT004  221937.53
## FT005   84772.92
## FT006  271128.02</code></pre>
<p>In total 225 features have been defined in the present data set, many of which most likely represent signal from different ions of the same compound. The aim of the grouping functions of this package are now to define which features most likely come from the same original compound. These feature grouping functions base on the following assumptions/properties of LC-MS data:</p>
<ul>
<li>Features (ions) of the same compound should have similar retention time.</li>
<li>The peak shape of extracted ion chromatograms (EIC) of features of the same compound should be similar as it should follow the elution pattern of the original compound from the chromatogram.</li>
<li>The abundance of features (ions) of the same compound should have a similar pattern across samples, i.e. if a compound is highly concentrated in one sample and low in another, all ions from it should follow the same pattern.</li>
</ul>
<p>The main method to perform the feature grouping is called <code>groupFeatures</code> which takes an <code>XCMSnExp</code> object (result object from the <code>xcms</code> pre-processing) as input as well as a parameter object to chose the grouping algorithm and specify its settings. At present the following approaches are supported:</p>
<ul>
<li>
<code>SimilarRtimeParam</code>: perform a <em>crude</em> grouping based on similar retention time.</li>
<li>
<code>EicCorrelationParam</code>: perform a feature grouping based on correlation of EICs.</li>
<li>
<code>AbundanceCorrelationParam</code>: perform a feature grouping based on correlation of feature abundances (values) across samples.</li>
</ul>
<p>Calling <code>groupFeatures</code> on an <code>xcms</code> result object will perform a feature grouping assigning each feature in the data set to a <em>feature group</em>. These feature groups are stored as an additional columns called <code>"feature_group"</code> in the <code>featureDefinition</code> data frame of the result object. Any subsequent <code>groupFeature</code> call will <em>sub-group</em> (refine) the identified feature groups further. It is thus possible to use a single grouping approach, or to combine multiple of them to generate the desired feature grouping. While the individual feature grouping algorithms can be called in any order, it is advised to use the <code>EicCorrelationParam</code> as last refinement step, because it is the computationally most expensive one, especially if applied to a result object without any pre-defined feature groups or if the feature groups are very large. In the subsequent sections we will apply the various feature grouping approaches subsequently.</p>
<p>Note also that we perform here a grouping of all defined features, but it would also be possible to <em>just</em> group a subset of interesting features (e.g. features found significant by a statistical analysis of the data set). How this can be achieved is described in the last section of this vignette.</p>
<div id="grouping-of-features-by-similar-retention-time" class="section level2">
<h2 class="hasAnchor">
<a href="#grouping-of-features-by-similar-retention-time" class="anchor"></a>Grouping of features by similar retention time</h2>
<p>The most intuitive and simple way to group features is based on their retention time. Before we perform this initial grouping we evaluate retention times and m/z of all features in the present data set.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/MSnbase/man/plot-methods.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)<span class="op">$</span><span class="kw">rtmed</span>, <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)<span class="op">$</span><span class="kw">mzmed</span>,
     xlab = <span class="st">"retention time"</span>, ylab = <span class="st">"m/z"</span>, main = <span class="st">"features"</span>,
     col = <span class="st">"#00000080"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html">grid</a></span>()
</pre></div>
<div class="figure">
<img src="LC-MS-feature-grouping_files/figure-html/feature-rt-mz-plot-1.png" alt="Plot of retention times and m/z for all features in the data set." width="768"><p class="caption">
Plot of retention times and m/z for all features in the data set.
</p>
</div>
<p>Especially in the earlier retention time range we can see features with about the same retention time. We below group features within a retention time window of 10 seconds.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">xdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">groupFeatures</a></span>(<span class="kw">xdata</span>, param = <span class="fu"><a href="../reference/groupFeatures-approximate-rtime.html">SimilarRtimeParam</a></span>(<span class="fl">10</span>))
</pre></div>
<p>The results from the feature grouping can be accessed with the <code>featureGroups</code> function. Below we determine the size of each of these feature groups (i.e. how many features are grouped together).</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
</pre></div>
<pre><code>## 
## FG.001 FG.002 FG.003 FG.004 FG.005 FG.006 FG.007 FG.008 FG.009 FG.010 FG.011 
##      4      3      1      2     10      5      2      2      2     17      6 
## FG.012 FG.013 FG.014 FG.015 FG.016 FG.017 FG.018 FG.019 FG.020 FG.021 FG.022 
##      1      1      1      2      3      2      4      2      1      4      7 
## FG.023 FG.024 FG.025 FG.026 FG.027 FG.028 FG.029 FG.030 FG.031 FG.032 FG.033 
##      8      4      1      6      4      1      3      2      2      6      3 
## FG.034 FG.035 FG.036 FG.037 FG.038 FG.039 FG.040 FG.041 FG.042 FG.043 FG.044 
##      1      3      4      3     10      4      5      1      5      3      1 
## FG.045 FG.046 FG.047 FG.048 FG.049 FG.050 FG.051 FG.052 FG.053 FG.054 FG.055 
##      5      1      2      3      9      5      6      4      5      5      6 
## FG.056 FG.057 FG.058 
##      3      6      3</code></pre>
<p>Below we plot the results from this feature grouping. Features being grouped together are connected with a line.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="fu"><a href="../reference/plotFeatureGroups.html">plotFeatureGroups</a></span>(<span class="kw">xdata</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html">grid</a></span>()
</pre></div>
<div class="figure">
<img src="LC-MS-feature-grouping_files/figure-html/feature-groups-rtime-plot-1.png" alt="Feature groups defined with a rt window of 10 seconds" width="768"><p class="caption">
Feature groups defined with a rt window of 10 seconds
</p>
</div>
<p>Let’s assume we are not totally happy with this feature grouping, also knowing that there were quite some shifts in retention times between runs. We thus re-perform the feature grouping based on similar retention time with a larger rt window. Before we have however to remove the previous results to avoid that these previous feature groups are simply refined with the following <code>groupFeatures</code> call.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="co">## Remove previous feature grouping results to repeat the rtime-based</span>
<span class="co">## feature grouping with different setting</span>
<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)<span class="op">$</span><span class="kw">feature_group</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>

<span class="co">## Repeat the grouping</span>
<span class="kw">xdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">groupFeatures</a></span>(<span class="kw">xdata</span>, <span class="fu"><a href="../reference/groupFeatures-approximate-rtime.html">SimilarRtimeParam</a></span>(<span class="fl">20</span>))
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
</pre></div>
<pre><code>## 
## FG.001 FG.002 FG.003 FG.004 FG.005 FG.006 FG.007 FG.008 FG.009 FG.010 FG.011 
##      7      1      2     15      4      2     23      1      2      2      4 
## FG.012 FG.013 FG.014 FG.015 FG.016 FG.017 FG.018 FG.019 FG.020 FG.021 FG.022 
##      5      3      8     10      6     10      4      2      8      4      6 
## FG.023 FG.024 FG.025 FG.026 FG.027 FG.028 FG.029 FG.030 FG.031 FG.032 FG.033 
##      4     10      9      6      3      7      5     13     10      8     11 
## FG.034 FG.035 
##      6      4</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="../reference/plotFeatureGroups.html">plotFeatureGroups</a></span>(<span class="kw">xdata</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/grid.html">grid</a></span>()
</pre></div>
<div class="figure">
<img src="LC-MS-feature-grouping_files/figure-html/feature-groups-rtime-plot2-1.png" alt="Feature groups defined with a rt window of 20 seconds" width="768"><p class="caption">
Feature groups defined with a rt window of 20 seconds
</p>
</div>
<p>Note that this grouping approach uses the <code>groupClosest</code> function which can group arbitrary numeric values together based on their similarity. Thus, the same grouping could also be achieved on a simple single <code>numeric</code> vector of retention times:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="fu"><a href="../reference/groupClosest.html">groupClosest</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)<span class="op">$</span><span class="kw">rtmed</span>, <span class="fl">20</span>)
</pre></div>
<pre><code>##   [1] 11  7  7  5  1 15  1  8 18  5  7  7  7  5 24  7  7  5 30  7 30  7  3 12 12
##  [26] 34 13  3 24 12 17 14  7 25  7 25  1  1 17  7 17 30 35  7 25 31 32 34 33  1
##  [51]  7  7  1  1 15  7 26 18 26  4  6  4 28  6  4 34 34 32 25 35  7 33  4 20  4
##  [76]  4 20 24 10  4  2 30  4  7 33 17 17 24 24 33 27 20 27  4 20 24 20 32 32 20
## [101] 28 28 12 27 26 30  7  7  4 32 11 16  4 24 13 31 15 34  4 15  4  4 23 33 32
## [126] 33  4 11 31 25 30 17 25 25 25 16 16 24 16 33 33 33 19 13 19 17 25 26 26 26
## [151] 15 33  7 10 30 31 18 31 29 29 31 16 20 15 20 15 24 24 30 30 16 29 31 32 23
## [176] 22 30 30 31 21 21 23 23 28 28 28 34  9 35 28 22 31 22 21 15 14 14 21 32 15
## [201] 14 22 31 11 18 12 29 17 33 22 22 17 17 30  9  7 35  7 29 14 14 15 30 14 14</code></pre>
<p>Grouping by similar retention time grouped the in total 225 features into 35 feature groups.</p>
</div>
<div id="grouping-of-features-by-abundance-correlation-across-samples" class="section level2">
<h2 class="hasAnchor">
<a href="#grouping-of-features-by-abundance-correlation-across-samples" class="anchor"></a>Grouping of features by abundance correlation across samples</h2>
<p>Assuming we are OK with the <em>crude</em> initial feature grouping from the previous section, we can next <em>refine</em> the feature groups considering also the feature abundances across samples. We can use the <code>groupFeatures</code> method with an <code>AbundanceCorrelationParam</code> object. This approach performs a pairwise correlation between the feature values (abundances; across samples) between all features of a predefined feature group (such as defined in the previous section). Features that have a correlation <code>&gt;= threshold</code> are grouped together. Feature grouping based on this approach works best for features with a higher variability in their concentration across samples. Parameter <code>subset</code> allows to restrict the analysis to a subset of samples and allows thus to e.g. exclude QC sample pools from this correlation as these could artificially increase the correlation. Other parameters are passed directly to the internal <code>featureValues</code> call that extracts the feature values on which the correlation should be performed.</p>
<p>Before performing the grouping we could also evaluate the correlation of features based on their (log2 transformed) abundances across samples with a heatmap.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">pheatmap</span>)
<span class="kw">fvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log2</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html">featureValues</a></span>(<span class="kw">xdata</span>, filled = <span class="fl">TRUE</span>))

<span class="kw">cormat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">fvals</span>), use = <span class="st">"pairwise.complete.obs"</span>)
<span class="kw">ann</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(fgroup = <span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">ann</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">cormat</span>)

<span class="kw">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span>(<span class="kw">cormat</span>, annotation_row = <span class="kw">ann</span>, cluster_rows = <span class="fl">TRUE</span>,
                cluster_cols = <span class="fl">TRUE</span>)
</pre></div>
<div class="figure">
<img src="LC-MS-feature-grouping_files/figure-html/abundance-correlation-heatmap-1.png" alt="Correlation of features based on feature abundances." width="576"><p class="caption">
Correlation of features based on feature abundances.
</p>
</div>
<p>Some large correlations can be observed for several groups of features, but many of them are not within the same <em>feature group</em> as defined in the previous section (i.e. are not eluting at the same time).</p>
<p>Below we use the <code>groupFeatures</code> with the <code>AbundanceCorrelationParam</code> to group features with a correlation higher than 0.7 including both detected and filled-in signal. Whether filled-in or only detected signal should be used in the correlation analysis should be evaluated from data set to data set. Note also that by default the correlation is performed on log2 transformed signals.</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="kw">xdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">groupFeatures</a></span>(<span class="kw">xdata</span>, <span class="fu"><a href="../reference/groupFeatures-abundance-correlation.html">AbundanceCorrelationParam</a></span>(threshold = <span class="fl">0.7</span>,
                                                        filled = <span class="fl">TRUE</span>))
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
</pre></div>
<pre><code>## 
##  FG.001.1  FG.001.2  FG.001.3  FG.002.1  FG.003.1 FG.004.01 FG.004.02 FG.004.03 
##         5         1         1         1         2         2         3         3 
## FG.004.04 FG.004.05 FG.004.06 FG.004.07 FG.004.08 FG.004.09  FG.005.1  FG.005.2 
##         2         1         1         1         1         1         2         1 
##  FG.005.3  FG.006.1 FG.007.01 FG.007.02 FG.007.03 FG.007.04 FG.007.05 FG.007.06 
##         1         2         6         6         2         2         1         1 
## FG.007.07 FG.007.08 FG.007.09 FG.007.10 FG.007.11  FG.008.1  FG.009.1  FG.010.1 
##         1         1         1         1         1         1         2         1 
##  FG.010.2  FG.011.1  FG.011.2  FG.011.3  FG.012.1  FG.012.2  FG.012.3  FG.012.4 
##         1         2         1         1         1         1         1         1 
##  FG.012.5  FG.013.1  FG.013.2  FG.014.1  FG.014.2  FG.014.3 FG.015.01 FG.015.02 
##         1         2         1         6         1         1         5         2 
## FG.015.03 FG.015.04 FG.015.05  FG.016.1  FG.016.2  FG.016.3 FG.017.01 FG.017.02 
##         1         1         1         4         1         1         5         2 
## FG.017.03 FG.017.04 FG.017.05  FG.018.1  FG.018.2  FG.018.3  FG.019.1  FG.019.2 
##         1         1         1         2         1         1         1         1 
##  FG.020.1  FG.020.2  FG.020.3  FG.020.4  FG.020.5  FG.021.1  FG.022.1  FG.022.2 
##         3         2         1         1         1         4         4         1 
##  FG.022.3  FG.023.1  FG.023.2  FG.023.3 FG.024.01 FG.024.02 FG.024.03 FG.024.04 
##         1         2         1         1         2         2         1         1 
## FG.024.05 FG.024.06 FG.024.07 FG.024.08  FG.025.1  FG.025.2  FG.025.3  FG.026.1 
##         1         1         1         1         5         3         1         2 
##  FG.026.2  FG.026.3  FG.026.4  FG.026.5  FG.027.1  FG.027.2  FG.028.1  FG.028.2 
##         1         1         1         1         2         1         4         1 
##  FG.028.3  FG.028.4  FG.029.1  FG.029.2  FG.029.3  FG.029.4 FG.030.01 FG.030.02 
##         1         1         2         1         1         1         4         3 
## FG.030.03 FG.030.04 FG.030.05 FG.031.01 FG.031.02 FG.031.03 FG.031.04 FG.031.05 
##         3         2         1         3         1         1         1         1 
## FG.031.06 FG.031.07 FG.031.08  FG.032.1  FG.032.2  FG.032.3  FG.032.4  FG.032.5 
##         1         1         1         2         1         1         1         1 
##  FG.032.6  FG.032.7 FG.033.01 FG.033.02 FG.033.03 FG.033.04 FG.033.05 FG.033.06 
##         1         1         2         2         2         2         1         1 
## FG.033.07  FG.034.1  FG.034.2  FG.034.3  FG.034.4  FG.034.5  FG.035.1  FG.035.2 
##         1         2         1         1         1         1         2         1 
##  FG.035.3 
##         1</code></pre>
<p>Many of the larger retention time-based feature groups have been splitted into two or more sub-groups based on the correlation of their feature abundances. We evaluate this for one specific feature group <code>"FG.025"</code> by plotting their pairwise correlation.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="kw">fts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span>(<span class="st">"FG.025"</span>, <span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
<span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">fvals</span>[<span class="kw">fts</span>, ]), gap = <span class="fl">0.1</span>, main = <span class="st">"FG.025"</span>)
</pre></div>
<div class="figure">
<img src="LC-MS-feature-grouping_files/figure-html/abundance-correlation-fg025-1.png" alt="Pairwise correlation plot for all features initially grouped into the feature group FG.025." width="768"><p class="caption">
Pairwise correlation plot for all features initially grouped into the feature group FG.025.
</p>
</div>
<p>Indeed, correlations can be seen only between some of the features in this retention time feature group, e.g. between <em>FT034</em> and <em>FG036</em>. Note however that this abundance correlation suffers from relatively few samples (8 in total), and a relatively small variance in abundances across these samples.</p>
<p>After feature grouping by abundance correlation, the 225 features have been grouped into 137 feature groups.</p>
</div>
<div id="grouping-of-features-by-eic-correlation" class="section level2">
<h2 class="hasAnchor">
<a href="#grouping-of-features-by-eic-correlation" class="anchor"></a>Grouping of features by EIC correlation</h2>
<p>The chromatographic peak shape of an ion of a compound should be highly similar to the elution pattern of this compound. Thus, features from the same compound are assumed to have similar peak shapes of their EICs <strong>within the same sample</strong>. Peak shape correlation can be performed with <code>groupFeatures</code> and the <code>EicCorrelationParam</code>. It is advisable to perform the peak shape correlation only on a subset of samples (because peak shape correlation is computationally intense and because chromatographic peaks of low intensity features are notoriously noisy). The <code>EicCorrelationParam</code> approach has thus the parameter <code>n</code> which allows to select the number of top samples (ordered by total intensity of feature abundances per feature group) on which the correlation should be performed. With an value of <code>n = 3</code> for each feature group the 3 samples with the highest signal for all features in that group will be first identified and then within each of these samples a pairwise correlation will be performed between peak shapes of all features of the group. The resulting correlation coefficients from these 3 samples will then be reduced to a single correlation coefficient by taking the 75% quantile across the 3 samples. This value is then subsequently compared with the threshold correlation coefficient (parameter <code>threshold</code>) and only features are grouped together that have a correlation coefficient larger than this value.</p>
<p>Below we group the features based on their EIC correlation in the two samples with the highest total signal for the respective feature groups. We require the correlation of the peak shape to be higher than 0.7. With <code>clean = TRUE</code> we also ensure that only the signal within the actually detected chromatographic peaks is used.</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="kw">xdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">groupFeatures</a></span>(<span class="kw">xdata</span>, <span class="fu"><a href="../reference/groupFeatures-eic-correlation.html">EicCorrelationParam</a></span>(threshold = <span class="fl">0.7</span>, n = <span class="fl">2</span>,
                                                  clean = <span class="fl">TRUE</span>))
</pre></div>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   1%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |===                                                                   |   5%
  |                                                                            
  |====                                                                  |   5%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |=====                                                                 |   7%
  |                                                                            
  |=====                                                                 |   8%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |======                                                                |   9%
  |                                                                            
  |=======                                                               |   9%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |=======                                                               |  11%
  |                                                                            
  |========                                                              |  11%
  |                                                                            
  |========                                                              |  12%
  |                                                                            
  |=========                                                             |  13%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |============                                                          |  16%
  |                                                                            
  |============                                                          |  17%
  |                                                                            
  |============                                                          |  18%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |=============                                                         |  19%
  |                                                                            
  |===============                                                       |  21%
  |                                                                            
  |===============                                                       |  22%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |==================                                                    |  26%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |====================                                                  |  28%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  29%
  |                                                                            
  |=====================                                                 |  31%
  |                                                                            
  |======================                                                |  31%
  |                                                                            
  |======================                                                |  32%
  |                                                                            
  |=======================                                               |  32%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  34%
  |                                                                            
  |=========================                                             |  35%
  |                                                                            
  |=========================                                             |  36%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |==========================                                            |  38%
  |                                                                            
  |===========================                                           |  38%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |============================                                          |  40%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |=============================                                         |  42%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |==============================                                        |  44%
  |                                                                            
  |===============================                                       |  44%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |================================                                      |  46%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  48%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |===================================                                   |  50%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |====================================                                  |  52%
  |                                                                            
  |=====================================                                 |  52%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |======================================                                |  55%
  |                                                                            
  |=======================================                               |  56%
  |                                                                            
  |========================================                              |  56%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |==========================================                            |  60%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |===========================================                           |  62%
  |                                                                            
  |============================================                          |  62%
  |                                                                            
  |=============================================                         |  64%
  |                                                                            
  |==============================================                        |  65%
  |                                                                            
  |==============================================                        |  66%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |================================================                      |  68%
  |                                                                            
  |================================================                      |  69%
  |                                                                            
  |=================================================                     |  69%
  |                                                                            
  |=================================================                     |  70%
  |                                                                            
  |=================================================                     |  71%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |==================================================                    |  72%
  |                                                                            
  |===================================================                   |  72%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |====================================================                  |  74%
  |                                                                            
  |====================================================                  |  75%
  |                                                                            
  |=====================================================                 |  75%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |=======================================================               |  78%
  |                                                                            
  |=======================================================               |  79%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  81%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |==========================================================            |  82%
  |                                                                            
  |==========================================================            |  83%
  |                                                                            
  |===========================================================           |  85%
  |                                                                            
  |============================================================          |  85%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  87%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |===============================================================       |  89%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |===============================================================       |  91%
  |                                                                            
  |================================================================      |  91%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |=================================================================     |  93%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |====================================================================  |  96%
  |                                                                            
  |====================================================================  |  97%
  |                                                                            
  |====================================================================  |  98%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |===================================================================== |  99%
  |                                                                            
  |======================================================================| 100%</code></pre>
<p>This is the most computationally intense approach since it involves also loading the raw MS data to extract the ion chromatograms for each feature. The results of the grouping are shown below.</p>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
</pre></div>
<pre><code>## 
##  FG.001.1.1  FG.001.2.1  FG.001.3.1  FG.002.1.1  FG.003.1.1 FG.004.01.1 
##           5           1           1           1           2           1 
## FG.004.01.2 FG.004.02.1 FG.004.03.1 FG.004.04.1 FG.004.05.1 FG.004.06.1 
##           1           3           3           2           1           1 
## FG.004.07.1 FG.004.08.1 FG.004.09.1  FG.005.1.1  FG.005.1.2  FG.005.2.1 
##           1           1           1           1           1           1 
##  FG.005.3.1  FG.006.1.1 FG.007.01.1 FG.007.02.1 FG.007.02.2 FG.007.03.1 
##           1           2           6           5           1           2 
## FG.007.04.1 FG.007.05.1 FG.007.06.1 FG.007.07.1 FG.007.08.1 FG.007.09.1 
##           2           1           1           1           1           1 
## FG.007.10.1 FG.007.11.1  FG.008.1.1  FG.009.1.1  FG.009.1.2  FG.010.1.1 
##           1           1           1           1           1           1 
##  FG.010.2.1  FG.011.1.1  FG.011.1.2  FG.011.2.1  FG.011.3.1  FG.012.1.1 
##           1           1           1           1           1           1 
##  FG.012.2.1  FG.012.3.1  FG.012.4.1  FG.012.5.1  FG.013.1.1  FG.013.1.2 
##           1           1           1           1           1           1 
##  FG.013.2.1  FG.014.1.1  FG.014.1.2  FG.014.2.1  FG.014.3.1 FG.015.01.1 
##           1           2           4           1           1           3 
## FG.015.01.2 FG.015.02.1 FG.015.03.1 FG.015.04.1 FG.015.05.1  FG.016.1.1 
##           2           2           1           1           1           2 
##  FG.016.1.2  FG.016.1.3  FG.016.2.1  FG.016.3.1 FG.017.01.1 FG.017.01.2 
##           1           1           1           1           3           2 
## FG.017.02.1 FG.017.03.1 FG.017.04.1 FG.017.05.1  FG.018.1.1  FG.018.1.2 
##           2           1           1           1           1           1 
##  FG.018.2.1  FG.018.3.1  FG.019.1.1  FG.019.2.1  FG.020.1.1  FG.020.1.2 
##           1           1           1           1           2           1 
##  FG.020.2.1  FG.020.3.1  FG.020.4.1  FG.020.5.1  FG.021.1.1  FG.021.1.2 
##           2           1           1           1           2           1 
##  FG.021.1.3  FG.022.1.1  FG.022.1.2  FG.022.2.1  FG.022.3.1  FG.023.1.1 
##           1           2           2           1           1           1 
##  FG.023.1.2  FG.023.2.1  FG.023.3.1 FG.024.01.1 FG.024.02.1 FG.024.03.1 
##           1           1           1           2           2           1 
## FG.024.04.1 FG.024.05.1 FG.024.06.1 FG.024.07.1 FG.024.08.1  FG.025.1.1 
##           1           1           1           1           1           5 
##  FG.025.2.1  FG.025.2.2  FG.025.3.1  FG.026.1.1  FG.026.2.1  FG.026.3.1 
##           2           1           1           2           1           1 
##  FG.026.4.1  FG.026.5.1  FG.027.1.1  FG.027.2.1  FG.028.1.1  FG.028.2.1 
##           1           1           2           1           4           1 
##  FG.028.3.1  FG.028.4.1  FG.029.1.1  FG.029.2.1  FG.029.3.1  FG.029.4.1 
##           1           1           2           1           1           1 
## FG.030.01.1 FG.030.01.2 FG.030.02.1 FG.030.02.2 FG.030.03.1 FG.030.04.1 
##           2           2           2           1           3           2 
## FG.030.05.1 FG.031.01.1 FG.031.01.2 FG.031.02.1 FG.031.03.1 FG.031.04.1 
##           1           2           1           1           1           1 
## FG.031.05.1 FG.031.06.1 FG.031.07.1 FG.031.08.1  FG.032.1.1  FG.032.2.1 
##           1           1           1           1           2           1 
##  FG.032.3.1  FG.032.4.1  FG.032.5.1  FG.032.6.1  FG.032.7.1 FG.033.01.1 
##           1           1           1           1           1           1 
## FG.033.01.2 FG.033.02.1 FG.033.02.2 FG.033.03.1 FG.033.03.2 FG.033.04.1 
##           1           1           1           1           1           1 
## FG.033.04.2 FG.033.05.1 FG.033.06.1 FG.033.07.1  FG.034.1.1  FG.034.1.2 
##           1           1           1           1           1           1 
##  FG.034.2.1  FG.034.3.1  FG.034.4.1  FG.034.5.1  FG.035.1.1  FG.035.1.2 
##           1           1           1           1           1           1 
##  FG.035.2.1  FG.035.3.1 
##           1           1</code></pre>
<p>In most cases, pre-defined feature groups (by the abundance correlation) were not further subdivided. Below we evaluate some of the feature groups starting with <em>FG.007.02</em> which was split into two different feature groups based on EIC correlation. We first extract the EICs for all features from this initial feature group. With <code>n = 1</code> we specify to extract the EIC only from the sample with the highest intensity.</p>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="kw">fts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span>(<span class="st">"FG.007.02"</span>, <span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
<span class="kw">eics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/featureChromatograms.html">featureChromatograms</a></span>(<span class="kw">xdata</span>, features = <span class="kw">fts</span>,
                             filled = <span class="fl">TRUE</span>, n = <span class="fl">1</span>)
</pre></div>
<p>Next we plot the EICs using a different color for each of the subgroups.</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="kw">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#ff000080"</span>, <span class="st">"#00ff0080"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">cols</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>)[<span class="kw">fts</span>])

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(mfrow = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>))
<span class="fu"><a href="../reference/plotOverlay.html">plotOverlay</a></span>(<span class="kw">eics</span>, col = <span class="kw">cols</span>[<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>)[<span class="kw">fts</span>]], lwd = <span class="fl">2</span>)
<span class="fu"><a href="../reference/plotOverlay.html">plotOverlay</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/MSnbase/man/normalise-methods.html">normalize</a></span>(<span class="kw">eics</span>), col = <span class="kw">cols</span>[<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>)[<span class="kw">fts</span>]], lwd = <span class="fl">2</span>)
</pre></div>
<div class="figure">
<img src="LC-MS-feature-grouping_files/figure-html/example-1-eic-1.png" alt="EICs of features from feature group FG.007.02, colors label different feature sub-groups. Shown are the actual intensities (left) and intensities normalized to 1 (right)." width="768"><p class="caption">
EICs of features from feature group FG.007.02, colors label different feature sub-groups. Shown are the actual intensities (left) and intensities normalized to 1 (right).
</p>
</div>
<p>One feature initially grouped together with all other features based on the abundance correlation was separated from them based on the EIC correlation. In addition, two features seem to have only a single peak, while the others have a double peak. Here it is not clear if it would be better to include the feature labeled in green in the main feature group, or if the feature group should be further splitted based on the presence of the additional peak. Since these EICs were all extracted from the same sample, the shift observed for the green colored feature the can not be the result from a mis-alignment hence suggesting that this feature might be indeed be from a different compound.</p>
<p>We evaluate next the sub-grouping in another feature group.</p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="kw">fts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span>(<span class="st">"FG.030.01"</span>, <span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
<span class="kw">eics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/featureChromatograms.html">featureChromatograms</a></span>(<span class="kw">xdata</span>, features = <span class="kw">fts</span>,
                             filled = <span class="fl">TRUE</span>, n = <span class="fl">1</span>)
</pre></div>
<p>Next we plot the EICs using a different color for each of the subgroups.</p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="kw">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#ff000080"</span>, <span class="st">"#00ff0080"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">cols</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>)[<span class="kw">fts</span>])

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(mfrow = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>))
<span class="fu"><a href="../reference/plotOverlay.html">plotOverlay</a></span>(<span class="kw">eics</span>, col = <span class="kw">cols</span>[<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>)[<span class="kw">fts</span>]], lwd = <span class="fl">2</span>)
<span class="fu"><a href="../reference/plotOverlay.html">plotOverlay</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/MSnbase/man/normalise-methods.html">normalize</a></span>(<span class="kw">eics</span>), col = <span class="kw">cols</span>[<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>)[<span class="kw">fts</span>]], lwd = <span class="fl">2</span>)
</pre></div>
<div class="figure">
<img src="LC-MS-feature-grouping_files/figure-html/example-2-eic-1.png" alt="EICs of features from feature group FG.030.01, colors label different feature sub-groups. Shown are the actual intensities (left) and intensities normalized to 1 (right)." width="768"><p class="caption">
EICs of features from feature group FG.030.01, colors label different feature sub-groups. Shown are the actual intensities (left) and intensities normalized to 1 (right).
</p>
</div>
<p>Based on the EIC correlation, the initial feature group <em>FG.030.01</em> was grouped into two separate sub-groups, each consisting of two features, one with a single peak and one with a double peak.</p>
<p>The grouping based on EIC correlation on the pre-defined feature groups from the previous sections grouped the 225 features into 164 feature groups.</p>
</div>
<div id="grouping-of-subsets-of-features" class="section level2">
<h2 class="hasAnchor">
<a href="#grouping-of-subsets-of-features" class="anchor"></a>Grouping of subsets of features</h2>
<p>In the previous sections we were always considering all features from the data set, but sometimes it could be desirable to just group a pre-defined set of features, for example features found to be of particular interest in a certain experiment (e.g. significant features). This can be easily achieved by assigning the features of interest to a initial feature group, using <code>NA</code> as group ID for all other features.</p>
<p>To illustrate this we <em>reset</em> all feature groups by setting them to <code>NA</code> and assign our features of interest (in this example just 30 randomly selected features) to an initial feature group <code>"FG"</code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)<span class="op">$</span><span class="kw">feature_group</span> <span class="op">&lt;-</span> <span class="fl">NA_character_</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">123</span>)
<span class="kw">fts_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)), <span class="fl">30</span>)
<span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">featureDefinitions</a></span>(<span class="kw">xdata</span>)<span class="op">$</span><span class="kw">feature_group</span>[<span class="kw">fts_idx</span>] <span class="op">&lt;-</span> <span class="st">"FG"</span>
</pre></div>
<p>Any call to <code>groupFeatures</code> would now simply sub-group this set of 30 features. Any feature which has an <code>NA</code> in the <code>"feature_group"</code> column will be ignored.</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="kw">xdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">groupFeatures</a></span>(<span class="kw">xdata</span>, <span class="fu"><a href="../reference/groupFeatures-approximate-rtime.html">SimilarRtimeParam</a></span>(diffRt = <span class="fl">20</span>))
<span class="kw">xdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hidden_aliases.html">groupFeatures</a></span>(<span class="kw">xdata</span>, <span class="fu"><a href="../reference/groupFeatures-abundance-correlation.html">AbundanceCorrelationParam</a></span>(threshold = <span class="fl">0.7</span>))
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu"><a href="../reference/feature-grouping.html">featureGroups</a></span>(<span class="kw">xdata</span>))
</pre></div>
<pre><code>## 
## FG.01.1 FG.01.2 FG.02.1 FG.03.1 FG.04.1 FG.04.2 FG.05.1 FG.06.1 FG.06.2 FG.07.1 
##       1       1       1       1       1       1       1       3       1       2 
## FG.07.2 FG.08.1 FG.09.1 FG.10.1 FG.11.1 FG.12.1 FG.13.1 FG.14.1 FG.14.2 FG.15.1 
##       1       1       1       1       1       1       1       1       1       1 
## FG.16.1 FG.16.2 FG.17.1 FG.17.2 
##       2       1       2       2</code></pre>
</div>
</div>
<div id="session-information" class="section level1">
<h1 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session information</h1>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span>()
</pre></div>
<pre><code>## R version 4.0.2 Patched (2020-09-10 r79182)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.1 LTS
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-openmp/libopenblasp-r0.3.8.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats4    parallel  stats     graphics  grDevices utils     datasets 
## [8] methods   base     
## 
## other attached packages:
##  [1] pheatmap_1.0.12       CompMetaboTools_0.2.2 faahKO_1.29.0        
##  [4] xcms_3.11.6           MSnbase_2.15.5        ProtGenerics_1.21.0  
##  [7] S4Vectors_0.27.12     mzR_2.23.1            Rcpp_1.0.5           
## [10] BiocParallel_1.23.2   Biobase_2.49.1        BiocGenerics_0.35.4  
## [13] BiocStyle_2.17.0     
## 
## loaded via a namespace (and not attached):
##  [1] vsn_3.57.0                  foreach_1.5.0              
##  [3] assertthat_0.2.1            highr_0.8                  
##  [5] BiocManager_1.30.10         affy_1.67.0                
##  [7] GenomeInfoDbData_1.2.3      yaml_2.2.1                 
##  [9] robustbase_0.93-6           impute_1.63.0              
## [11] pillar_1.4.6                backports_1.1.9            
## [13] lattice_0.20-41             glue_1.4.2                 
## [15] limma_3.45.14               digest_0.6.25              
## [17] GenomicRanges_1.41.6        RColorBrewer_1.1-2         
## [19] XVector_0.29.3              colorspace_1.4-1           
## [21] htmltools_0.5.0             preprocessCore_1.51.0      
## [23] Matrix_1.2-18               plyr_1.8.6                 
## [25] MALDIquant_1.19.3           XML_3.99-0.5               
## [27] pkgconfig_2.0.3             bookdown_0.20              
## [29] zlibbioc_1.35.0             scales_1.1.1               
## [31] RANN_2.6.1                  affyio_1.59.0              
## [33] cpp11_0.2.1                 tibble_3.0.3               
## [35] farver_2.0.3                IRanges_2.23.10            
## [37] ggplot2_3.3.2               ellipsis_0.3.1             
## [39] SummarizedExperiment_1.19.6 MassSpecWavelet_1.55.0     
## [41] magrittr_1.5                crayon_1.3.4               
## [43] memoise_1.1.0               evaluate_0.14              
## [45] fs_1.5.0                    ncdf4_1.17                 
## [47] doParallel_1.0.15           MASS_7.3-53                
## [49] tools_4.0.2                 lifecycle_0.2.0            
## [51] matrixStats_0.56.0          stringr_1.4.0              
## [53] munsell_0.5.0               DelayedArray_0.15.7        
## [55] pcaMethods_1.81.0           compiler_4.0.2             
## [57] pkgdown_1.6.1.9000          GenomeInfoDb_1.25.11       
## [59] mzID_1.27.0                 systemfonts_0.3.1          
## [61] rlang_0.4.7                 grid_4.0.2                 
## [63] RCurl_1.98-1.2              iterators_1.0.12           
## [65] MsCoreUtils_1.1.3           bitops_1.0-6               
## [67] rmarkdown_2.3               gtable_0.3.0               
## [69] codetools_0.2-16            R6_2.4.1                   
## [71] knitr_1.29                  rprojroot_1.3-2            
## [73] ragg_0.3.1                  desc_1.2.0                 
## [75] stringi_1.5.3               vctrs_0.3.4                
## [77] DEoptimR_1.0-8              xfun_0.17</code></pre>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Johannes Rainer, Mar Garcia-Aloy.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
